# 📊 War for the Overworld - 完整状态指示器图鉴

## 📚 图鉴概述

本图鉴详细介绍了 War for the Overworld 世界中的完整状态指示器系统，从基础的颜色编码到复杂的状态管理，从单体指示器到全局状态系统。通过深入了解状态指示器的各种功能，你将能够快速识别战场情况，做出正确的战术决策！现在系统已扩展支持建筑状态和金矿状态的高亮显示。

### 🎮 游戏内体验
在游戏中状态指示器会自动显示，包括以下功能：
- 🎨 **颜色编码**: 不同颜色代表不同的行为状态
- 📊 **实时更新**: 状态指示器实时反映单位状态
- 🔍 **快速识别**: 一眼就能看出单位在做什么
- 🎯 **战术辅助**: 帮助制定更好的战术策略
- 🏗️ **建筑状态**: 建筑状态高亮（未完成、被摧毁、受损）
- ⛏️ **金矿状态**: 金矿挖掘状态高亮（正常、繁忙、满员）

### 🚀 核心特性

- **统一接口**: 所有生物使用相同的状态指示器系统
- **可扩展性**: 支持自定义状态和颜色
- **高性能**: 轻量级渲染，不影响游戏性能
- **向后兼容**: 提供回退机制，确保系统稳定性
- **工程师管理**: 支持工程师工作状态管理和自动拒绝多余工程师
- **空闲优化**: 工程师空闲1秒后自动转为游荡状态，提高工作效率

## 🏗️ 架构设计

### 核心类结构

```
StatusIndicator
├── 状态颜色管理
├── 渲染逻辑
├── 自定义配置
└── 工具方法

StatusIndicatorManager
├── 多实例管理
├── 工厂方法
└── 生命周期管理
```

## 📋 API 文档

### StatusIndicator 类

#### 构造函数
StatusIndicator(width=4, height=8, border_thickness=1)

**参数**:
- `width`: 指示器宽度（像素）
- `height`: 指示器高度（像素）
- `border_thickness`: 边框厚度（像素）

#### 主要方法

##### `set_custom_color(state, color)`
设置自定义状态颜色

**参数**:
- `state`: 状态名称
- `color`: RGB颜色值元组

##### `get_color(state)`
获取状态对应的颜色

**返回值**: RGB颜色值元组

##### `render(screen, creature_x, creature_y, creature_size, state)`
渲染状态指示器

**参数**:
- `screen`: pygame屏幕对象
- `creature_x`: 生物屏幕X坐标
- `creature_y`: 生物屏幕Y坐标
- `creature_size`: 生物大小
- `state`: 生物当前状态

##### `get_status_description(state)`
获取状态的文字描述

##### `get_all_states()`
获取所有支持的状态列表

##### `get_status_info(state)`
获取状态的完整信息

##### `render_building_highlight(screen, screen_x, screen_y, tile_size, status)`
渲染建筑状态高亮 - 只绘制边框，不填充中间区域

**参数**:
- `screen`: pygame屏幕对象
- `screen_x`: 屏幕X坐标
- `screen_y`: 屏幕Y坐标
- `tile_size`: 瓦片大小
- `status`: 建筑状态 ('incomplete', 'destroyed', 'damaged')

##### `render_mining_highlight(screen, screen_x, screen_y, tile_size, miners_count)`
渲染金矿挖掘状态高亮

**参数**:
- `screen`: pygame屏幕对象
- `screen_x`: 屏幕X坐标
- `screen_y`: 屏幕Y坐标
- `tile_size`: 瓦片大小
- `miners_count`: 挖掘者数量

### StatusIndicatorManager 类

#### 构造函数
manager = StatusIndicatorManager()

#### 主要方法

##### `create_indicator(name, width, height, border_thickness)`
创建新的状态指示器

##### `get_indicator(name)`
获取指定的状态指示器

##### `remove_indicator(name)`
移除指定的状态指示器

##### `list_indicators()`
获取所有指示器名称列表

## 🎨 默认状态颜色

| 状态                | 颜色   | RGB值           | 描述         | 图标 |
| ------------------- | ------ | --------------- | ------------ | ---- |
| `fighting`          | 红色   | (255, 0, 0)     | 战斗中       | 🔴    |
| `moving`            | 绿色   | (0, 255, 0)     | 移动中       | 🟢    |
| `moving_to_mine`    | 绿色   | (0, 255, 0)     | 移动到挖掘点 | 🟢    |
| `mining`            | 深棕色 | (139, 69, 19)   | 挖掘中       | 🟤    |
| `fleeing`           | 深灰色 | (64, 64, 64)    | 逃跑中       | ⚫    |
| `returning_to_base` | 青色   | (0, 255, 255)   | 返回基地     | 🔵    |
| `wandering`         | 橙色   | (255, 165, 0)   | 游荡中       | 🟠    |
| `idle`              | 白色   | (255, 255, 255) | 空闲         | ⚪    |
| `moving_to_site`    | 绿色   | (0, 255, 0)     | 前往工地     | 🟢    |
| `constructing`      | 深棕色 | (139, 69, 19)   | 建造中       | 🟤    |
| `repairing`         | 黄色   | (255, 215, 0)   | 修理中       | 🟡    |
| `upgrading`         | 紫色   | (138, 43, 226)  | 升级中       | 🟣    |
| `returning`         | 青色   | (0, 255, 255)   | 返回中       | 🔵    |
| `default`           | 灰色   | (128, 128, 128) | 未知状态     | ⚪    |

### 建筑状态颜色

| 状态         | 颜色   | RGB值           | 描述       | 图标 | 边框宽度 |
| ------------ | ------ | --------------- | ---------- | ---- | -------- |
| `incomplete` | 红色   | (255, 100, 100) | 未完成建筑 | 🔴    | 2px      |
| `destroyed`  | 深红色 | (255, 0, 0)     | 被摧毁建筑 | 🔴    | 4px      |
| `damaged`    | 黄色   | (255, 255, 0)   | 受损建筑   | 🟡    | 3px      |
| `completed`  | 绿色   | (0, 255, 0)     | 完成建筑   | 🟢    | -        |

### 金矿状态颜色

| 状态            | 颜色 | RGB值           | 描述       | 图标 | 边框宽度 |
| --------------- | ---- | --------------- | ---------- | ---- | -------- |
| `mining_normal` | 绿色 | (0, 255, 0)     | 正常挖掘   | 🟢    | 2px      |
| `mining_busy`   | 黄色 | (255, 255, 0)   | 较多挖掘者 | 🟡    | 2px      |
| `mining_full`   | 红色 | (255, 100, 100) | 满员挖掘   | 🔴    | 3px      |
| `depleted`      | 棕色 | (139, 69, 19)   | 枯竭矿脉   | 🟤    | -        |

## 🔧 使用示例

### 基础使用
创建状态指示器并渲染状态指示器

### 自定义颜色
创建指示器并设置自定义颜色，使用自定义状态

### 管理器使用
创建管理器，创建不同类型的指示器，使用特定指示器

### 集成到游戏类
在游戏类中初始化状态指示器，在渲染生物时渲染状态指示器

## 🎮 游戏集成

### 在WarForTheOverworldGame中的使用

**初始化时**:
- 如果状态指示器可用，创建StatusIndicator实例
- 否则设置为None

**渲染时**:
- 如果状态指示器存在，渲染状态指示器
- 否则回退到旧的颜色系统

## 🎨 视觉规范

### 指示器规格

- **默认尺寸**: 4x8像素
- **形状**: 竖向空心长方形
- **边框**: 1像素厚度
- **位置**: 生物右上角，距离生物边缘2像素

### 颜色规范

- **高对比度**: 确保在各种背景下可见
- **语义化**: 颜色与状态含义相关
- **一致性**: 相同状态使用相同颜色

### 渲染位置

```
生物位置 (x, y)
    ┌─────────┐
    │  生物   │
    │         │
    └─────────┘
              ┌─┐  ← 状态指示器
              └─┘
```

## 🔍 调试和测试

### 调试功能
- 获取状态信息
- 列出所有状态

### 测试用例
测试默认颜色、自定义颜色和描述功能

## 🚀 扩展指南

### 添加新状态

1. **更新默认颜色**: 在StatusIndicator.__init__中添加新状态颜色
2. **更新描述**: 在get_status_description中添加新状态描述
3. **使用新状态**: 使用新状态进行渲染

### 自定义指示器样式
可以创建圆形指示器等自定义样式，需要重写render方法

## 📝 更新日志

### v1.0 - 初始版本
- ✅ **核心功能**: StatusIndicator类实现
- ✅ **管理器**: StatusIndicatorManager类
- ✅ **默认状态**: 8种预定义状态和颜色
- ✅ **自定义支持**: 支持自定义状态颜色
- ✅ **游戏集成**: 与WarForTheOverworldGame集成
- ✅ **向后兼容**: 提供回退机制

## 🎉 开始使用

状态指示器系统已经集成到游戏中，您可以通过以下方式开始使用：

1. **导入系统**: 从src.ui.status_indicator导入StatusIndicator
2. **创建实例**: 创建StatusIndicator实例
3. **开始渲染**: 使用render方法渲染状态指示器

享受统一、可扩展的状态指示器系统！📊✨

## 🧙‍♂️ 召唤系统集成

### 召唤位置检测
状态指示器系统与召唤系统深度集成，提供智能的位置占用检测功能。

#### 🎯 位置占用检测机制
- **碰撞半径计算**: 使用与物理系统相同的算法 (size * 0.6)
- **生物检测**: 检查与所有现有生物的碰撞
- **英雄检测**: 检查与所有英雄的碰撞
- **精确计算**: 基于单位实际大小和碰撞半径

#### 🎨 召唤视觉反馈
召唤模式下的鼠标高亮颜色系统：
- **红色**: 地形不合适（岩石、未挖掘区域）
- **橙色**: 位置被其他单位占用
- **青色**: 可以正常召唤

#### 🚫 召唤逻辑改进
修改了游戏的召唤逻辑，现在召唤怪物时：
- ✅ 召唤前检查目标位置
- 🚫 如果位置被占用则**拒绝召唤**
- 💰 不消耗金币，不创建单位
- 📢 显示明确的错误提示

### 召唤位置算法

#### 🧮 碰撞判定公式
计算所需的安全距离，如果实际距离小于安全距离，则位置被占用

#### 📊 性能优化
- **按需检测**: 只在召唤模式下进行位置检查
- **静默模式**: 鼠标移动时不打印调试信息
- **详细模式**: 实际召唤时显示详细信息

### 用户体验改进

#### 🎮 玩家操作
1. **选择召唤模式**: 按4键或5键
2. **观察鼠标高亮**: 
   - 青色 = 可以召唤
   - 橙色 = 位置被占用
   - 红色 = 地形不合适
3. **点击召唤**: 只有青色区域可以成功召唤

#### 💡 战术影响
1. **位置规划**: 需要考虑单位布局和召唤空间
2. **空间管理**: 拥挤区域难以召唤新单位
3. **防御策略**: 可以通过布局阻止敌人召唤
4. **资源保护**: 避免意外消耗金币

### 技术实现

#### 🔧 核心方法
检查召唤位置是否被占用的核心逻辑：
1. 计算召唤位置的世界坐标
2. 计算召唤生物的碰撞半径
3. 检查与所有现有单位的距离
4. 如果距离小于安全距离，则位置被占用

#### 🔗 集成点
- **召唤检查**: 在 `_summon_creature` 方法中集成
- **视觉反馈**: 在 `_render_mouse_cursor` 中集成
- **物理系统**: 禁用了单位间碰撞解决，保持召唤控制

*精确的召唤，战术的开始！* 🧙‍♂️⚡🎯